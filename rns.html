<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈöèÊú∫ÁÇπÂêçÁ≥ªÁªü</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: bold;
            color: #555;
        }

        select, button {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .checkbox-section {
            margin-bottom: 30px;
        }

        .checkbox-header {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .checkbox-header h3 {
            margin: 0;
            color: #555;
        }

        .checkbox-header .toggle-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        .checkbox-item label {
            cursor: pointer;
            color: #555;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .results {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            min-height: 100px;
        }

        .result-card {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            min-width: 300px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .card-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .card-name {
            font-size: 2.0em;
        }

        .config-controls {
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        .config-controls button {
            margin: 5px;
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .config-controls button.upload-btn {
            background: linear-gradient(45deg, #007bff, #6610f2);
        }

        .config-controls button.reset-btn {
            background: linear-gradient(45deg, #dc3545, #fd7e14);
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 8px 16px;
            background: linear-gradient(45deg, #007bff, #6610f2);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }

        .file-label:hover {
            opacity: 0.9;
        }

        .cloud-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px;
        }

        .cloud-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .checkbox-group {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .result-card {
                min-width: 240px;
                padding: 25px;
            }
            
            .card-number {
                font-size: 2.0em;
            }
            
            .card-name {
                font-size: 1.6em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé≤ ÈöèÊú∫ÁÇπÂêçÁ≥ªÁªü</h1>
        
        <div class="config-controls" id="configControls">
            <input type="file" id="configFile" class="file-input" accept=".json">
            <label for="configFile" class="file-label">üìÅ ‰∏ä‰º†ÈÖçÁΩÆÊñá‰ª∂</label>
            <div class="cloud-toggle">
                <input type="checkbox" id="cloudToggle">
                <label for="cloudToggle">‰ΩøÁî®‰∫ëÁ´ØÈÖçÁΩÆ</label>
            </div>
            <button class="reset-btn" onclick="resetToDefault()">üîÑ ÈáçÁΩÆ‰∏∫ÈªòËÆ§ÈÖçÁΩÆ</button>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label for="numSelect">ÊäΩÂèñ‰∫∫Êï∞:</label>
                <select id="numSelect">
                    <option value="1">1‰∫∫</option>
                    <option value="2">2‰∫∫</option>
                    <option value="3">3‰∫∫</option>
                    <option value="4">4‰∫∫</option>
                    <option value="5">5‰∫∫</option>
                    <option value="6">6‰∫∫</option>
                    <option value="7">7‰∫∫</option>
                    <option value="8">8‰∫∫</option>
                    <option value="9">9‰∫∫</option>
                    <option value="10">10‰∫∫</option>
                </select>
            </div>
            
            <button id="startBtn">ÂºÄÂßãÊäΩÂ•ñ</button>
        </div>

        <div class="checkbox-section">
            <div class="checkbox-header" onclick="toggleCheckboxSection()">
                <h3>üìã ‰∫∫ÂëòÂêçÂçï</h3>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="checkbox-group" id="nameCheckboxes">
                <!-- ‰∫∫ÂëòÂ§çÈÄâÊ°ÜÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>

        <div class="results" id="resultsContainer">
            <!-- ÁªìÊûúÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
        </div>
    </div>

    <script>
        // ‰∫ëÁ´ØÈÖçÁΩÆËÑöÊú¨URL
        const CLOUD_CONFIG_URL = 'https://pan.panyt.eu.org/d/0/config/cr/10/cloud_config.js';

        class RandomPicker {
            constructor() {
                this.people = [];
                this.selectedPeople = [];
                this.version = null;
                this.isCheckboxExpanded = false;
                this.useCloudConfig = false;
                this.cloudConfigLoaded = false;
                this.init();
            }

            async init() {
                // Á´ãÂç≥Âä†ËΩΩÊú¨Âú∞ÈÖçÁΩÆÂπ∂Ê∏≤ÊüìÁïåÈù¢
                await this.loadLocalConfig();
                if (this.people.length === 0) {
                    this.loadDefaultConfig();
                }
                this.renderCheckboxes();
                this.bindEvents();
                
                this.loadCloudConfigStatus();
                if (this.useCloudConfig) {
                    this.asyncLoadCloudConfig();
                }
            }

            async loadLocalConfig() {
                const savedConfig = localStorage.getItem('randomPickerConfig');
                if (savedConfig) {
                    try {
                        const config = JSON.parse(savedConfig);
                        this.people = config.people;
                        this.version = config.version;
                    } catch (e) {
                        console.error('Êú¨Âú∞ÈÖçÁΩÆËß£ÊûêÂ§±Ë¥•:', e);
                    }
                }
            }

            loadDefaultConfig() {
                this.people = [
                    { id: 1, name: "Â∞èÁæé", weight: 1.0, enabled: true },
                    { id: 2, name: "Â∞èÂ∏Ö", weight: 1.0, enabled: true },
                    { id: 3, name: "Â∞èÊòé", weight: 2.0, enabled: true }
                ];
                this.version = "1.0.0";
            }

            renderCheckboxes() {
                const container = document.getElementById('nameCheckboxes');
                container.innerHTML = '';
                
                this.people.forEach(person => {
                    const checkboxItem = document.createElement('div');
                    checkboxItem.className = 'checkbox-item';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `person-${person.id}`;
                    checkbox.checked = person.enabled;
                    
                    const label = document.createElement('label');
                    label.htmlFor = `person-${person.id}`;
                    label.textContent = person.name;
                    
                    checkbox.addEventListener('change', (e) => {
                        person.enabled = e.target.checked;
                    });
                    
                    checkboxItem.appendChild(checkbox);
                    checkboxItem.appendChild(label);
                    container.appendChild(checkboxItem);
                });
            }

            saveConfig() {
                const config = {
                    version: this.version,
                    people: this.people
                };
                localStorage.setItem('randomPickerConfig', JSON.stringify(config));
            }

            loadCloudConfigStatus() {
                const status = localStorage.getItem('useCloudConfig');
                this.useCloudConfig = status === 'true';
                document.getElementById('cloudToggle').checked = this.useCloudConfig;
            }

            saveCloudConfigStatus() {
                localStorage.setItem('useCloudConfig', this.useCloudConfig);
            }

            async asyncLoadCloudConfig() {
                try {
                    console.log('Ê≠£Âú®Âä†ËΩΩ‰∫ëÁ´ØÈÖçÁΩÆ...');
                    
                    const response = await fetch(CLOUD_CONFIG_URL + '?t=' + Date.now());
                    if (!response.ok) {
                        throw new Error('ÁΩëÁªúÂìçÂ∫î‰∏çÊ≠£Â∏∏');
                    }
                    
                    const scriptContent = await response.text();
                    
                    // Âä®ÊÄÅÊâßË°åËÑöÊú¨
                    const script = document.createElement('script');
                    script.textContent = scriptContent;
                    document.head.appendChild(script);
                    
                    if (window.CLOUD_CONFIG) {
                        this.people = window.CLOUD_CONFIG.people;
                        this.version = window.CLOUD_CONFIG.version;
                        this.cloudConfigLoaded = true;
                        
                        // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                        this.saveConfig();
                        
                        // Êõ¥Êñ∞ÁïåÈù¢
                        this.renderCheckboxes();
                        
                        console.log('‰∫ëÁ´ØÈÖçÁΩÆÂ∑≤Âä†ËΩΩÂπ∂Â∫îÁî®');
                    } else {
                        throw new Error('‰∫ëÁ´ØÈÖçÁΩÆÊ†ºÂºè‰∏çÊ≠£Á°Æ');
                    }
                    
                    // ÁßªÈô§ËÑöÊú¨ÂÖÉÁ¥†
                    document.head.removeChild(script);
                } catch (error) {
                    console.error('‰∫ëÁ´ØÈÖçÁΩÆÂä†ËΩΩÂ§±Ë¥•:', error);
                }
            }

            bindEvents() {
                document.getElementById('startBtn').addEventListener('click', () => {
                    this.startPicking();
                });

                document.getElementById('cloudToggle').addEventListener('change', (e) => {
                    this.useCloudConfig = e.target.checked;
                    this.saveCloudConfigStatus();
                    
                    if (this.useCloudConfig && !this.cloudConfigLoaded) {
                        this.asyncLoadCloudConfig();
                    }
                });

                document.getElementById('configFile').addEventListener('change', (e) => {
                    this.handleFileUpload(e.target.files[0]);
                });

                // ÂÖ®ÈÄâÂäüËÉΩ
                const selectAllCheckbox = document.createElement('input');
                selectAllCheckbox.type = 'checkbox';
                selectAllCheckbox.id = 'selectAll';
                selectAllCheckbox.addEventListener('change', (e) => {
                    const checkboxes = document.querySelectorAll('#nameCheckboxes input[type="checkbox"]');
                    checkboxes.forEach(cb => {
                        cb.checked = e.target.checked;
                        const person = this.people.find(p => p.id == cb.id.split('-')[1]);
                        if (person) person.enabled = e.target.checked;
                    });
                });

                const selectAllLabel = document.createElement('label');
                selectAllLabel.htmlFor = 'selectAll';
                selectAllLabel.textContent = 'ÂÖ®ÈÄâ';
                selectAllLabel.style.fontWeight = 'bold';
                selectAllLabel.style.color = '#667eea';

                const selectAllContainer = document.createElement('div');
                selectAllContainer.className = 'checkbox-item';
                selectAllContainer.appendChild(selectAllCheckbox);
                selectAllContainer.appendChild(selectAllLabel);

                const checkboxGroup = document.getElementById('nameCheckboxes');
                checkboxGroup.insertBefore(selectAllContainer, checkboxGroup.firstChild);
            }

            handleFileUpload(file) {
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        let config;
                        try {
                            config = JSON.parse(content);
                        } catch {
                            throw new Error('ËØ∑‰∏ä‰º†JSONÊ†ºÂºèÁöÑÈÖçÁΩÆÊñá‰ª∂');
                        }

                        if (config.people && Array.isArray(config.people)) {
                            this.people = config.people;
                            this.version = config.version || '1.0.0';
                            this.saveConfig();
                            this.renderCheckboxes();
                            alert('ÈÖçÁΩÆÊñá‰ª∂Âä†ËΩΩÊàêÂäüÔºÅ');
                        } else {
                            throw new Error('ÈÖçÁΩÆÊñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°Æ');
                        }
                    } catch (error) {
                        alert('ÈÖçÁΩÆÊñá‰ª∂Ëß£ÊûêÂ§±Ë¥•: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }

            startPicking() {
                const numToPick = parseInt(document.getElementById('numSelect').value);
                const enabledPeople = this.people.filter(p => p.enabled);

                if (enabledPeople.length < numToPick) {
                    alert(`ÂêØÁî®ÁöÑ‰∫∫ÂëòÊï∞Èáè(${enabledPeople.length})Â∞ë‰∫éË¶ÅÊäΩÂèñÁöÑÊï∞Èáè(${numToPick})`);
                    return;
                }

                this.selectedPeople = this.weightedRandomPick(enabledPeople, numToPick);
                this.displayResults();
            }

            weightedRandomPick(people, count) {
                const result = [];
                let availablePeople = [...people];

                for (let i = 0; i < count; i++) {
                    if (availablePeople.length === 0) break;

                    // ËÆ°ÁÆóÊÄªÊùÉÈáç
                    const totalWeight = availablePeople.reduce((sum, person) => sum + person.weight, 0);
                    
                    // ‰ΩøÁî® Crypto API ÁîüÊàêÊõ¥ÂÆâÂÖ®ÁöÑÈöèÊú∫Êï∞
                    const randomArray = new Uint32Array(1);
                    window.crypto.getRandomValues(randomArray);
                    
                    // Â∞ÜÈöèÊú∫Êï∞ËΩ¨Êç¢‰∏∫ 0-1 ‰πãÈó¥ÁöÑÊµÆÁÇπÊï∞
                    const random = (randomArray[0] / 4294967295) * totalWeight;
                    
                    let currentWeight = 0;
                    let selectedPerson = null;
                    
                    for (let j = 0; j < availablePeople.length; j++) {
                        currentWeight += availablePeople[j].weight;
                        if (random <= currentWeight) {
                            selectedPerson = availablePeople[j];
                            availablePeople.splice(j, 1); // ÁßªÈô§Â∑≤ÈÄâ‰∫∫ÂëòÔºåÈÅøÂÖçÈáçÂ§ç
                            break;
                        }
                    }

                    if (selectedPerson) {
                        result.push(selectedPerson);
                    }
                }

                return result;
            }

            displayResults() {
                const container = document.getElementById('resultsContainer');
                container.innerHTML = '';

                this.selectedPeople.forEach(person => {
                    const card = document.createElement('div');
                    card.className = 'result-card';
                    card.innerHTML = `
                        <div class="card-number">#${person.id}</div>
                        <div class="card-name">${person.name}</div>
                    `;
                    container.appendChild(card);
                });
            }
        }

        // ÂàáÊç¢Â§çÈÄâÊ°ÜÂå∫ÂüüÁöÑÊòæÁ§∫/ÈöêËóè
        function toggleCheckboxSection() {
            const checkboxGroup = document.getElementById('nameCheckboxes');
            const toggleIcon = document.querySelector('.toggle-icon');
            
            if (checkboxGroup.style.display === 'grid' || checkboxGroup.style.display === '') {
                checkboxGroup.style.display = 'none';
                toggleIcon.textContent = '‚ñº';
            } else {
                checkboxGroup.style.display = 'grid';
                toggleIcon.textContent = '‚ñ≤';
            }
        }

        // ÊòæÁ§∫ÈÖçÁΩÆÊéßÂà∂ÊåâÈíÆ
        function showConfigControls() {
            document.getElementById('configControls').style.display = 'block';
        }

        // ÈáçÁΩÆ‰∏∫ÈªòËÆ§ÈÖçÁΩÆ
        function resetToDefault() {
            if (confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆ‰∏∫ÈªòËÆ§ÈÖçÁΩÆÂêóÔºü')) {
                localStorage.removeItem('randomPickerConfig');
                localStorage.removeItem('useCloudConfig');
                location.reload();
            }
        }

        // ÂàùÂßãÂåñÂ∫îÁî®
        document.addEventListener('DOMContentLoaded', () => {
            new RandomPicker();
        });
    </script>
</body>
</html>